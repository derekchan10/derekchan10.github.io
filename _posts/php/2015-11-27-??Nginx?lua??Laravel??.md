---
layout: post
title: ??Nginx?lua??Laravel??
category: PHP
tags: Nginx,lua,Laravel
keywords: Nginx,lua,Laravel
description: 
---

?????????????????????Laravel?????????????????????Nginx?????????????????Url??????Nginx?????Module?????Action????????Nginx???????????????????????????????Nginx????????

?????????????Nginx????????Lua??????????Laravel??????????????????

**Nginx**

        location ~ ^/(.*) {
            rewrite_by_lua_file lua/verify_route.lua; #????lua
        }
        
        # ????
        location = /checkroute {
            proxy_pass http://$newcar_proxy;
        }
        
        location @new {
            add_header 'X-ROUTE-STATUS' 'new'; #?????????new
            proxy_pass http://$newcar_proxy; #???proxy
        }
        
        location @old {
            add_header 'X-ROUTE-STATUS' 'old'; #?????????old
            proxy_pass http://app_server; #???proxy
        }


**verify_route.lua**

        ngx.req.set_header("X-ORG-REQUEST-URI", ngx.var.uri)
        ngx.req.set_header("X-ORG-REQUEST-METHOD", ngx.var.request_method)
        res = ngx.location.capture("/checkroute")
        
        if res.status == 404 then
            ngx.exec("@old")
        end
        
        ngx.exec("@new")


**Laravel Route**

        // ????
        Route::get('checkroute', function(Illuminate\Http\Request $request){
        
            $realReq = new \Illuminate\Http\Request([],[],[],[],[],[
                'REQUEST_URI'=&gt;$request-&gt;server('HTTP_X_ORG_REQUEST_URI'), 
                'REQUEST_METHOD'=&gt;$request-&gt;server('HTTP_X_ORG_REQUEST_METHOD')
            ]);
        
            $route = Route::getRoutes()-&gt;match($realReq);
        
            if ($route instanceof \Symfony\Component\HttpKernel\Exception\NotFoundHttpException) {
                abort(404);
            }
        
            abort(200);
        
        });


?????????lua??Laravel???????????????lua????????????Request?????????????????????????????????Laravel??

